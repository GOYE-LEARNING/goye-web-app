generator client {
  provider = "prisma-client-js"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String        @id @default(cuid())
  first_name    String
  last_name     String
  email_address String        @unique
  password      String
  country       String
  state         String
  phone_number  String
  role          String        @default("student")
  level         String
  completed     String        @default("false")
  createdAt     DateTime      @default(now())
  isOnline      Boolean       @default(false)
  lastActive    DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  user_pic      String?
  enrollment    Enrollment[]
  post          Post[]
  reply         Reply[]
  quizAttempt   QuizAttempt[] // Added missing relation
  likes Likes[]
}

model Otp {
  id        String   @id @default(cuid()) // Changed from uuid() to cuid() for consistency
  email     String
  code      String
  createdAt DateTime @default(now())
  expiresIn DateTime
}

model Post {
  id        String   @id @default(cuid())
  title     String
  content   String
  userId    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  replies   Reply[]  @relation("PostReplies")
  likes     Likes[]  // Add this line
  
  @@map("posts")
}

model Reply {
  id        String   @id @default(cuid())
  content   String
  userId    String
  postId    String
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade, name: "PostReplies")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes     Likes[]  // Add this line
  
  @@map("replies")
}

model Likes {
  id      String   @id @default(cuid()) // Use cuid() for consistency
  userId  String   // Track which user liked
  postId  String?  // Make optional for reply likes
  replyId String?  // Make optional for post likes
  post    Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  reply   Reply?   @relation(fields: [replyId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  
  // Ensure a user can only like a post/reply once
  @@unique([userId, postId])
  @@unique([userId, replyId])
  // Ensure a like is either for a post OR a reply, not both
}

model Course {
  id                       String       @id @default(cuid()) // Changed from uuid() to cuid()
  course_title             String
  course_short_description String
  course_description       String
  course_level             String
  course_image             String
  createdAt                DateTime     @default(now()) // Added missing createdAt
  updatedAt                DateTime     @updatedAt // Added missing updatedAt
  enrollment               Enrollment[]
  material                 Material[]
  module                   Module[]
  objectives               Objectives[]
  quiz                     Quiz[]
}

model Event {
  id String @id @default(ulid())
  event_name String
  event_description String
  event_time String
  event_data String
  event_type String
  event_link String
}

model Enrollment {
  id        String   @id @default(cuid()) // Changed from uuid() to cuid()
  userId    String
  courseId  String
  createdAt DateTime @default(now())
  status    String   @default("incomplete") // Fixed typo: "oncomplete" â†’ "incomplete"
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId]) // Prevent duplicate enrollments
}

model Module {
  id                 String   @id @default(cuid()) // Changed from ulid() to cuid()
  module_title       String
  module_description String
  module_duration    String
  courseId           String
  order              Int      @default(0) // Added for ordering
  createdAt          DateTime @default(now()) // Added missing createdAt
  updatedAt          DateTime @updatedAt // Added missing updatedAt
  lesson             Lesson[]
  course             Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
}

model Lesson {
  id           String   @id @default(cuid()) // Changed from ulid() to cuid()
  lesson_title String
  lesson_video String
  moduleId     String
  order        Int      @default(0) // Added for ordering
  duration     Int? // Added duration in minutes
  createdAt    DateTime @default(now()) // Added missing createdAt
  updatedAt    DateTime @updatedAt // Added missing updatedAt
  module       Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
}

model Material {
  id                   String   @id @default(cuid()) // Changed from ulid() to cuid()
  material_title       String
  material_description String
  material_pages       Int
  material_document    String
  courseId             String
  createdAt            DateTime @default(now()) // Added missing createdAt
  updatedAt            DateTime @updatedAt // Added missing updatedAt
  course               Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
}

model Quiz {
  id           String        @id @default(cuid())
  title        String
  description  String?
  course       Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  courseId     String
  duration     Int? // in minutes
  passingScore Int           @default(70) // percentage
  maxAttempts  Int           @default(3)
  questions    Question[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  QuizAttempt  QuizAttempt[]

  @@map("quizzes")
}

model Question {
  id            String   @id @default(cuid())
  question      String // The question text
  options       String[] // Array of choices for multiple choice
  correctAnswer String // The correct answer
  explanation   String? // Explanation of the answer
  points        Int      @default(1) // Points for this question
  order         Int // Order in the quiz
  quiz          Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  quizId        String
  createdAt     DateTime @default(now())

  @@map("questions")
}

model QuizAttempt {
  id          String    @id @default(cuid())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  quiz        Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  quizId      String
  score       Int // Percentage score
  answers     Json // Store user's answers: { questionId: "selectedAnswer" }
  completed   Boolean   @default(false)
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  @@unique([userId, quizId, startedAt]) // Prevent duplicate attempts at same time
  @@map("quiz_attempts")
}

model Objectives {
  id               String   @id @default(cuid()) // Changed from ulid() to cuid()
  objective_title1 String
  objective_title2 String
  objective_title3 String
  objective_title4 String
  objective_title5 String
  courseId         String
  createdAt        DateTime @default(now()) // Added missing createdAt
  updatedAt        DateTime @updatedAt // Added missing updatedAt
  course           Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
}
